name: "CI/CD Pipeline"

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-and-test:
    name: "Lint & Test"
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: "ğŸ“¥ Checkout code"
        uses: actions/checkout@v4

      - name: "â˜• Setup JDK 17"
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: "ğŸ“¦ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "22.9.0"
          cache: "npm"

      - name: "ğŸ”§ Install Dependencies"
        run: npm ci

      - name: "ğŸ§¹ Run ESLint"
        run: npm run lint

      - name: "ğŸ’… Run Prettier"
        run: npm run format

      - name: "ğŸ§ª Run Unit Tests"
        run: npm test -- --coverage

      - name: "ğŸ“Š Upload Coverage Report"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

      - name: "ğŸ”” Discord - Failure"
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"embeds\": [{\"title\": \"âŒ CI Pipeline Failed\", \"description\": \"Branch: \`${{ github.ref_name }}\`\\nCommit: \`${{ github.sha }}\`\\n[View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\", \"color\": 15158332}]}" \
               $DISCORD_WEBHOOK

      - name: "ğŸ”” Discord - Success"
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"embeds\": [{\"title\": \"âœ… CI Passed\", \"description\": \"Branch: \`${{ github.ref_name }}\` - All checks passed!\", \"color\": 3066993}]}" \
               $DISCORD_WEBHOOK


  build-android:
    name: "Build Android APK"
    runs-on: ubuntu-latest
    needs: lint-and-test
    timeout-minutes: 30

    steps:
      - name: "ğŸ“¥ Checkout code"
        uses: actions/checkout@v4

      - name: "â˜• Setup JDK 17"
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: "ğŸ“¦ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "22.9.0"
          cache: "npm"

      - name: "ğŸ”§ Install Dependencies"
        run: npm ci

      - name: "ğŸ“¥ Install Android SDK + Accept Licenses + Install NDK"
        run: |
          echo "ğŸ“¥ Installing cmdline-tools..."

          # create folder
          mkdir -p "$ANDROID_HOME/cmdline-tools"
          cd "$ANDROID_HOME/cmdline-tools"

          # Download latest command line tools
          wget https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdline-tools.zip

          # Extract tools
          unzip cmdline-tools.zip -d latest
          rm cmdline-tools.zip

          echo "ğŸ“œ Accepting licenses..."
          yes | "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" --licenses

          echo "ğŸ“¦ Installing NDK..."
          "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" "ndk;28.0.12674087"


      - name: "ğŸ“± Cache Gradle"
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: "ğŸ”¨ Build Android Release"
        working-directory: android
        run: chmod +x gradlew && ./gradlew assembleRelease --no-daemon

      - name: "ğŸ“¦ Upload APK"
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: android/app/build/outputs/apk/release/*.apk
          retention-days: 7

      - name: "ğŸ”” Discord - Build Failed"
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"embeds\": [{\"title\": \"âŒ Android Build Failed\", \"description\": \"[Logs Here](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\", \"color\": 15158332}]}" \
               $DISCORD_WEBHOOK



  deploy:
    name: "Deploy to Play Store"
    runs-on: ubuntu-latest
    needs: build-android
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    timeout-minutes: 20

    environment:
      name: production
      url: https://play.google.com/store/apps

    steps:
      - name: "ğŸ“¥ Checkout code"
        uses: actions/checkout@v4

      - name: "â˜• Setup JDK 17"
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: "ğŸ“¦ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "22.9.0"
          cache: "npm"

      - name: "ğŸ”§ Install Dependencies"
        run: npm ci

      - name: "ğŸ’ Setup Ruby"
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: true
          working-directory: android

      - name: "ğŸš€ Install Fastlane"
        run: |
          cd android
          bundle config set --local path 'vendor/bundle'
          bundle install

      - name: "ğŸ” Setup Google Play Credentials"
        env:
          GOOGLE_PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
        run: |
          echo "$GOOGLE_PLAY_SERVICE_ACCOUNT_JSON" > android/fastlane/matrixcredential.json
          chmod 600 android/fastlane/matrixcredential.json

      - name: "ğŸš€ Deploy to Google Play Store"
        working-directory: android
        run: bundle exec fastlane playstore

      - name: "ğŸ§¹ Cleanup Credentials"
        if: always()
        run: rm -f android/fastlane/matrixcredential.json

      - name: "ğŸ”” Discord - Deploy Failed"
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"embeds\": [{\"title\": \"âŒ Deploy Failed\", \"description\": \"[Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\", \"color\": 15158332}]}" \
               $DISCORD_WEBHOOK

      - name: "ğŸ”” Discord - Deploy Success"
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"embeds\": [{\"title\": \"âœ… Deployed Successfully\", \"description\": \"App pushed to Play Store! ğŸ‰\", \"color\": 3066993}]}" \
               $DISCORD_WEBHOOK
