name: "CI/CD Pipeline"

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

# Cancel previous runs if a new one is triggere
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-and-test:
    name: "Lint & Test"
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: "üì• Checkout code"
        uses: actions/checkout@v4

      - name: "‚òï Set up JDK 17"
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: "üì¶ Set up Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "22.9.0"
          cache: "npm"

      - name: "üîß Install Dependencies"
        run: npm ci

      - name: "üßπ Run Lint"
        run: npm run lint

      - name: "üíÖ Run Prettier Check"
        run: npm run format

      - name: "üß™ Run Unit Tests"
        run: npm test -- --coverage

      - name: "üìä Upload Coverage Report"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

      - name: "üîî Discord notification - Failure"
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
          -X POST \
          -d "{\"embeds\": [{\"title\": \"‚ùå CI Pipeline Failed\", \"description\": \"Branch: \`${{ github.ref_name }}\`\\nCommit: \`${{ github.sha }}\`\\n[View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\", \"color\": 15158332}]}" \
          $DISCORD_WEBHOOK

      - name: "üîî Discord notification - Success"
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
          -X POST \
          -d "{\"embeds\": [{\"title\": \"‚úÖ CI Pipeline Passed\", \"description\": \"Branch: \`${{ github.ref_name }}\`\\nAll tests passed successfully!\", \"color\": 3066993}]}" \
          $DISCORD_WEBHOOK

  build-android:
    name: "Build Android APK"
    runs-on: ubuntu-latest
    needs: lint-and-test
    timeout-minutes: 30

    steps:
      - name: "üì• Checkout code"
        uses: actions/checkout@v4

      - name: "‚òï Setup JDK 17"
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: "üì¶ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "22.9.0"
          cache: "npm"

      - name: "üîß Install Dependencies"
        run: npm ci

      - name: "üì± Cache Gradle"
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: "üî® Build Android Release"
        working-directory: android
        run: ./gradlew assembleRelease --no-daemon

      - name: "üì¶ Upload APK"
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: android/app/build/outputs/apk/release/*.apk
          retention-days: 7

      - name: "üîî Discord notification - Build Failed"
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
          -X POST \
          -d "{\"embeds\": [{\"title\": \"‚ùå Android Build Failed\", \"description\": \"[View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\", \"color\": 15158332}]}" \
          $DISCORD_WEBHOOK

  deploy:
    name: "Deploy to Play Store"
    runs-on: ubuntu-latest
    needs: build-android
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    timeout-minutes: 20
    environment:
      name: production
      url: https://play.google.com/store/apps

    steps:
      - name: "üì• Checkout code"
        uses: actions/checkout@v4

      - name: "‚òï Setup JDK 17"
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: "üì¶ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "22.9.0"
          cache: "npm"

      - name: "üîß Install Dependencies"
        run: npm ci

      - name: "üíé Setup Ruby"
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: true
          working-directory: android

      - name: "üöÄ Install Fastlane"
        run: |
          cd android
          bundle config set --local path 'vendor/bundle'
          bundle install

      - name: "üîê Setup Google Play Credentials"
        env:
          GOOGLE_PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
        run: |
          echo "$GOOGLE_PLAY_SERVICE_ACCOUNT_JSON" > android/fastlane/matrixcredential.json
          chmod 600 android/fastlane/matrixcredential.json

      - name: "üì± Cache Gradle"
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: "üöÄ Deploy to Google Play Store"
        working-directory: android
        run: bundle exec fastlane playstore

      - name: "üßπ Cleanup Credentials"
        if: always()
        run: rm -f android/fastlane/matrixcredential.json

      - name: "üîî Discord notification - Deploy Failed"
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
          -X POST \
          -d "{\"embeds\": [{\"title\": \"‚ùå Deploy Failed\", \"description\": \"Deployment to Play Store failed\\n[View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\", \"color\": 15158332, \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"}]}" \
          $DISCORD_WEBHOOK

      - name: "üîî Discord notification - Deploy Success"
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
          -X POST \
          -d "{\"embeds\": [{\"title\": \"‚úÖ Deploy Successful\", \"description\": \"App successfully deployed to Google Play Store! üéâ\\nCommit: \`${{ github.sha }}\`\\nAuthor: ${{ github.actor }}\", \"color\": 3066993, \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"}]}" \
          $DISCORD_WEBHOOK