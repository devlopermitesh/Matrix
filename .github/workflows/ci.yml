name: "CI/CD Pipeline"

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-and-test:
    name: "Lint & Test"
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: "ðŸ“¥ Checkout code"
        uses: actions/checkout@v4

      - name: "â˜• Setup JDK 17"
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: "ðŸ“¦ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "22.9.0"
          cache: "npm"

      - name: "ðŸ”§ Install Dependencies"
        run: npm ci

      - name: "ðŸ§¹ Run ESLint"
        run: npm run lint

      - name: "ðŸ’… Run Prettier"
        run: npm run format

      - name: "ðŸ§ª Run Unit Tests"
        run: npm test -- --coverage

      - name: "ðŸ“Š Upload Coverage Report"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

      - name: "ðŸ”” Discord - Failure"
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"embeds\": [{\"title\": \"âŒ CI Pipeline Failed\", \"description\": \"Branch: \`${{ github.ref_name }}\`\\nCommit: \`${{ github.sha }}\`\\n[View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\", \"color\": 15158332}]}" \
               $DISCORD_WEBHOOK

      - name: "ðŸ”” Discord - Success"
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"embeds\": [{\"title\": \"âœ… CI Passed\", \"description\": \"Branch: \`${{ github.ref_name }}\` - All checks passed!\", \"color\": 3066993}]}" \
               $DISCORD_WEBHOOK


  build-android:
    name: "Build Android APK"
    runs-on: ubuntu-latest
    needs: lint-and-test
    timeout-minutes: 30

    steps:
      - name: "ðŸ“¥ Checkout code"
        uses: actions/checkout@v4

      - name: "â˜• Setup JDK 17"
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: "ðŸ“¦ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "22.9.0"
          cache: "npm"

      - name: "ðŸ”§ Install Dependencies"
        run: npm ci

      - name: "ðŸ“¥ Install Android SDK + Accept Licenses + Install NDK"
        run: |
          echo "ðŸ“¥ Installing cmdline-tools..."

          # create folder
          mkdir -p "$ANDROID_HOME/cmdline-tools"
          cd "$ANDROID_HOME/cmdline-tools"

          # Download latest command line tools
          wget https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdline-tools.zip

          # Extract tools
          unzip cmdline-tools.zip -d latest
          rm cmdline-tools.zip

          echo "ðŸ“œ Accepting licenses..."
          yes | "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" --licenses

          echo "ðŸ“¦ Installing NDK..."
          "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" "ndk;28.0.12674087"


      - name: "ðŸ“± Cache Gradle"
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: "ðŸ”¨ Build Android Release"
        working-directory: android
        run: chmod +x gradlew && ./gradlew assembleRelease --no-daemon

      - name: "ðŸ“¦ Upload APK"
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: android/app/build/outputs/apk/release/*.apk
          retention-days: 7

      - name: "ðŸ”” Discord - Build Failed"
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"embeds\": [{\"title\": \"âŒ Android Build Failed\", \"description\": \"[Logs Here](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\", \"color\": 15158332}]}" \
               $DISCORD_WEBHOOK

 
  
  deploy:
    name: "Deploy to Play Store"
    runs-on: ubuntu-latest
    needs: build-android
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    timeout-minutes: 20

    environment:
      name: production
      url: https://play.google.com/store/apps

    steps:
      - name: "ðŸ“¥ Checkout code"
        uses: actions/checkout@v4

      - name: "â˜• Setup JDK 17"
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: "ðŸ“¦ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "22.9.0"
          cache: "npm"

      - name: "ðŸ”§ Install Dependencies"
        run: npm ci

      - name: "ðŸ’Ž Setup Ruby"
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: false
          working-directory: android

      - name: "ðŸ’Ž Setup Fastlane Environment"
        working-directory: android
        run: |
          bundle lock --add-platform x86_64-linux
          bundle lock --add-platform ruby
          bundle install --path vendor/bundle

      - name: "ðŸ“œ Accept Android SDK Licenses"
        run: yes | sudo /usr/local/lib/android/sdk/cmdline-tools/latest/bin/sdkmanager --licenses

      - name: "ðŸ” Setup Play Store Credentials"
        env:
          GOOGLE_PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
        run: |
          echo "$GOOGLE_PLAY_SERVICE_ACCOUNT_JSON" > android/fastlane/matrixcredential.json
          chmod 600 android/fastlane/matrixcredential.json

      - name: Make gradlew executable
        run: chmod +x android/gradlew

      - name: "ðŸš€ Deploy to Google Play Store"
        working-directory: android
        run: bundle exec fastlane playstore

      - name: "ðŸ§¹ Cleanup Credentials"
        if: always()
        run: rm -f android/fastlane/matrixcredential.json

      - name: "ðŸ”” Discord - Deploy Failed"
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" -X POST -d @- $DISCORD_WEBHOOK <<'EOF'
          {
            "embeds": [
              {
                "title": "âŒ Deploy Failed",
                "description": "[Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})",
                "color": 15158332
              }
            ]
          }
          EOF

      - name: "ðŸ”” Discord - Success"
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" -X POST -d @- $DISCORD_WEBHOOK <<'EOF'
          {
            "embeds": [
              {
                "title": "âœ… Deployed Successfully",
                "description": "App pushed to Play Store! ðŸŽ‰",
                "color": 3066993
              }
            ]
          }
          EOF
            